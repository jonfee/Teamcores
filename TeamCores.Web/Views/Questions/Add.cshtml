@{
    ViewData["Title"] = "新增考题";
}
@section head_script
{
    <script src="~/js/pattern.js"></script>
}
@section style{
    <link href="~/css/question/add.css" lang="scss" rel="stylesheet" />
}
<div class="content-body">
    <i-form ref="formValidate" :model="question" :rules="validateRules" :label-width="80">
        <Form-item class="w-48" label="题目" prop="Topic">
            <i-input v-model="question.Topic" placeholder="题目"></i-input>
        </Form-item>
        <Form-item class="w-48" label="所属课程" prop="CourseId">
            <i-select v-model="question.CourseId">
                <i-option v-for="item in courses" :value="item.CourseId" :key="item.CourseId">{{item.Title}}</i-option>
            </i-select>
        </Form-item>
        <Form-item class="w-48" label="题目类型" prop="Type">
            <i-select v-model="question.Type">
                <i-option v-for="item in QuestionType.items" :value="item.value" :key="item.value">{{item.text}}</i-option>
            </i-select>
        </Form-item>

        <Form-item class="w800" label="选项与答案" prop="AnswerOptions">
            <div class="answer-options">
                <ul class="tab-list">
                    <li v-for="(item, index) in answeroptions" :key="index">
                        <template v-if="index == answeroptions.length - 1">
                            <span>
                                <i-input v-model="item.Code" placeholder="请输入答案编号" :maxlength="6" />
                            </span>
                            <span :title="item.Answer">
                                <i-input v-model="item.Answer" placeholder="请输入答案内容" :maxlength="200" />
                            </span>
                            <span>
                                <Checkbox v-model="item.IsRight">是否为正确答案</Checkbox>
                            </span>
                        </template>
                        <template v-else>
                            <span>{{item.Code}}</span>
                            <span :title="item.value">{{item.Answer}}</span>
                            <span :title="item.value">{{item.IsRight?'正确答案':'错误答案'}}</span>
                        </template>
                        <i-button type="text" v-on:click="onRemoveOption(index)">
                            <Icon type="close-circled"></Icon>
                        </i-button>
                    </li>
                    <li v-if="answeroptions.length <= 7" class="add">
                        <a href="javascript:void(0)" v-on:click="onAddOption">+</a>
                    </li>
                </ul>
            </div>
        </Form-item>

        <Form-item class="w-48 float-right">
            <i-button type="primary" v-on:click="handleSubmit('formValidate')">提交</i-button>
            <i-button type="ghost" v-on:click="handleReset('formValidate')" style="margin-left: 8px">重置</i-button>
        </Form-item>
    </i-form>
</div>
@section title_actions{
    <i-button type="success" v-on:click="goList">返回列表</i-button>
}
@section page_script{
    <script>
        var vm = new Vue({
            el: '#content',
            data: {
                subjects: {},
                courses: {},
                // 考题对象
                question: {
                    CourseId: 0,
                    Topic: "",
                    Type: '',
                    AnswerOptions: {},
                },
                answeroptions: [
                    {
                        Code: '',
                        Answer: '',
                        IsRight: false
                    }
                ], // 答案集合
                // 验证规则
                validateRules: {
                    Topic:
                    [
                        {
                            required: true,
                            message: "题目主题不能为空"
                        }
                    ],
                    CourseId: [
                        {
                            required: true,
                            message: "请选择所属课程"
                        }
                    ],
                    Type: [
                        {
                            required: true,
                            message: "请选择题目类型"
                        }
                    ]
                }
            },
            created() {
                this.getCourses();
            },
            methods: {
                goList() {
                    location = "/questions/index";
                },
                /**
                 * 保存
                 * @@param name 表单名称
                 */
                handleSubmit(name) {
                    this.$refs[name].validate((valid) => {
                        if (valid) {
                            switch (this.question.Type) {
                                //单选题验证
                            case QuestionType.SINGLE_CHOICE.value:
                            {
                                if (!this.answeroptions || this.answeroptions.length <= 1) {
                                    this.$Message.error("至少添加两个答案!");
                                    return;
                                }

                                let lastOption = this.answeroptions[this.answeroptions.length - 1];
                                if (lastOption.Code.trim().length == 0) {
                                    this.$Message.error('请输入答案编号!');

                                    return;
                                }

                                if (lastOption.Answer.trim().length == 0) {
                                    this.$Message.error('请输入答案内容!');

                                    return;
                                }

                                var existRight = this.answeroptions.some((item) => {
                                    return item.IsRight == true;
                                });
                                if (!existRight) {
                                    this.$Message.error('必须有一个答案为正确答案!');

                                    return;
                                }

                                this.question.AnswerOptions = { Options: this.answeroptions };


                            }
                            default:
                                break;
                            }

                            console.log(this.question);
                            Ajax.post({
                                url: '/api/question/add',
                                data: this.question,
                                success: (response) => {
                                    var data = response.data;
                                    if (!data.Error) {
                                        this.$Message.success("添加成功!");
                                        setTimeout(() => {
                                                location = "/questions/index";
                                            },
                                            1000);
                                    } else {
                                        this.$Message.error(data.Message);
                                    }
                                },
                                error: (error) => {
                                    this.$Message.error('操作失败，请重试！');
                                }
                            });
                        }
                    });
                },
                /**
                 * 重置
                 * @@param name 表单名称
                 */
                handleReset(name) {
                    this.$refs[name].resetFields();
                },
                /**
                 * 获取所有的课程
                 */
                getCourses() {
                    var _this = this;
                    Ajax.post({
                        url: "/api/course/search",
                        data: {
                            pageIndex: 1,
                            pageSize: 100
                        },
                        success: (response) => {
                            var data = response.data;
                            if (!data.Error) {
                                const pager = data.Data;
                                _this.courses = pager.Table;
                            }
                        },
                        error: (error) => {
                        }
                    });
                },
                /**
                 * 删除选项
                 */
                onRemoveOption(index) {
                    if (this.answeroptions.length > 0)
                        this.answeroptions.splice(index, 1);
                },
                /**
                 * 删除选项
                 */
                onAddOption() {
                    if (this.answeroptions.length > 0) {
                        const lastOption = this.answeroptions[this.answeroptions.length - 1];
                        if (lastOption.Code.trim().length == 0) {
                            this.$Message.error('请输入答案编号!');
                            return;
                        }
                        if (lastOption.Answer.trim().length == 0) {
                            this.$Message.error('请输入答案内容!');
                            return;
                        }

                    }
                    this.answeroptions.push({
                        Code: '',
                        Answer: '',
                        IsRight: false
                    });
                }

            }
        });
    </script>
}